#!/bin/sh
set -e

if [ "$1" = 'run' ]; then
  #install additionnal dependencies
  IFS=',' read -r -a libarr <<< "$LIBMOD"
  for libel in "${libarr[@]}"
  do
      apt-get install $libel -y
  done

  #enable apache modules
  IFS=',' read -r -a apaarr <<< "$APAMOD"
  for apael in "${apaarr[@]}"
  do
      a2enmod $apael
  done

  #install php mods
  IFS=',' read -r -a phparr <<< "$PHPMOD"
  for phpel in "${phparr[@]}"
  do
      apt-get install php-$phpel -y
  done

  #update pecl repository
  printf "\n" | pecl channel-update pecl.php.net
  mount -o remount,exec,suid /tmp
  mount -o remount,exec,suid /var/tmp
  #install pecl mods
  IFS=',' read -r -a peaarr <<< "$PEAMOD"
  for peael in "${peaarr[@]}"
  do
      printf "\n" | pecl install $peael
  done

  #run other script (cron, modules, etc)
  if [ ! -f "$SHFILE" ]
  then
    echo "file not found"
  else
    chmod +x $SHFILE
    echo "run $SHFILE"
    $SHFILE
  fi

  #apply changes
  service apache2 restart
fi

#run instructions after install
echo "Hey you ! Yes, please run this :" && echo
#start doc
echo "certbot --apache --non-interactive --agree-tos --email $EMAIL --domains $DOMAINS certonly"
echo "service apache2 restart"
#end doc
echo
